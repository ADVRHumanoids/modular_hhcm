os: linux
dist: focal
language: python
cache: pip

branches:
  only:
    - python3
    - /^v\d+\.\d+\.\d+.*$/ # version tags

notifications:
  email:
    recipients:
      - edoardo.romiti@iit.it
      - arturo.laurenzi@iit.it
    on_success: never
    on_failure: always

install:
  - echo "Travis tag is $TRAVIS_TAG"
  - sudo sh -c 'echo "deb https://apt-archive.postgresql.org/pub/repos/apt focal-pgdg main" > /etc/apt/sources.list.d/postgresql.list'
  - sudo sh -c 'echo "deb [arch=amd64 signed-by=/usr/share/keyrings/com.rabbitmq.team.gpg] https://deb1.rabbitmq.com/rabbitmq-erlang/ubuntu/focal focal main" > /etc/apt/sources.list.d/rabbitmq.list'
  - sudo sh -c 'echo "deb [arch=amd64 signed-by=/usr/share/keyrings/com.rabbitmq.team.gpg] https://deb2.rabbitmq.com/rabbitmq-erlang/ubuntu/focal focal main" >> /etc/apt/sources.list.d/rabbitmq.list'
  - sudo sh -c 'echo "deb [arch=amd64 signed-by=/usr/share/keyrings/com.rabbitmq.team.gpg] https://deb1.rabbitmq.com/rabbitmq-server/ubuntu/focal focal main" >> /etc/apt/sources.list.d/rabbitmq.list'
  - sudo sh -c 'echo "deb [arch=amd64 signed-by=/usr/share/keyrings/com.rabbitmq.team.gpg] https://deb2.rabbitmq.com/rabbitmq-server/ubuntu/focal focal main" >> /etc/apt/sources.list.d/rabbitmq.list'
  - sudo apt update
  - sudo apt install lsb-release
  - sudo sh -c 'echo "deb http://packages.ros.org/ros/ubuntu $(lsb_release -sc) main" > /etc/apt/sources.list.d/ros-latest.list'
  - sudo apt install curl
  - curl -s https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc | sudo apt-key add -
  - sudo apt update
  - sudo apt install ros-noetic-desktop-full 
  - pip install pyinstaller
  - pip install -e .

script:
  - source /opt/ros/noetic/setup.bash
  - cd src/modular/web/
  - pyinstaller RobotBuilder.spec
  - ls dist/RobotBuilder # fail if does not exist

deploy:
  provider: releases
  api_key: $GITHUB_TOKEN
  file: dist/RobotBuilder
  skip_cleanup: true
  on:
    tags: true
